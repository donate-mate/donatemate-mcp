name: Deploy MCP to Staging

on:
  pull_request:
    branches:
      - staging
    types: [opened, synchronize, reopened]
  push:
    branches:
      - staging

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '20'
  AWS_REGION: 'us-east-2'
  ENVIRONMENT: 'staging'

jobs:
  deploy:
    name: Deploy MCP Stack to Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-MCP-Deploy

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Type check
        run: npm run type-check --workspaces --if-present
        continue-on-error: true

      - name: CDK Bootstrap (if needed)
        working-directory: packages/infrastructure
        run: |
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }} \
            --context environment=${{ env.ENVIRONMENT }}

      - name: CDK Diff
        id: cdk-diff
        working-directory: packages/infrastructure
        run: |
          npx cdk diff \
            --context environment=${{ env.ENVIRONMENT }} \
            --require-approval never \
            > cdk-diff.txt 2>&1 || true

          # Truncate diff if too large
          if [ $(wc -c < cdk-diff.txt) -gt 10000 ]; then
            head -c 10000 cdk-diff.txt > cdk-diff-truncated.txt
            echo -e "\n\n... (output truncated due to size)" >> cdk-diff-truncated.txt
            mv cdk-diff-truncated.txt cdk-diff.txt
          fi

      - name: Comment CDK Diff on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('packages/infrastructure/cdk-diff.txt', 'utf8');
            const body = `## CDK Diff for MCP Stack (Staging)

            <details>
            <summary>Click to expand CDK diff</summary>

            \`\`\`
            ${diff}
            \`\`\`

            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Deploy MCP Stack
        working-directory: packages/infrastructure
        run: |
          npx cdk deploy DonateMate-MCP-Staging \
            --context environment=${{ env.ENVIRONMENT }} \
            --require-approval never \
            --outputs-file mcp-outputs.json

      - name: Comment deployment status on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let websocketUrl = 'Not available';
            let connectionsTable = 'Not available';

            try {
              const outputs = JSON.parse(fs.readFileSync('packages/infrastructure/mcp-outputs.json', 'utf8'));
              websocketUrl = outputs['DonateMate-MCP-Staging']?.WebSocketUrl || 'Not available';
              connectionsTable = outputs['DonateMate-MCP-Staging']?.ConnectionsTableOutput || 'Not available';
            } catch (e) {
              console.log('Could not read MCP outputs');
            }

            const body = `## ✅ MCP Staging Deployment Successful

            **Environment:** Staging
            **WebSocket Endpoint:** ${websocketUrl}
            **Connections Table:** ${connectionsTable}

            ### Deployed Resources:
            - ✅ WebSocket API Gateway
            - ✅ DynamoDB Connections Table
            - ✅ Lambda: mcp-connect (JWT validation)
            - ✅ Lambda: mcp-disconnect (cleanup)
            - ✅ Lambda: mcp-message (MCP protocol)

            ### Quick Links:
            - [CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logsV2:log-groups)
            - [Lambda Functions](https://console.aws.amazon.com/lambda/home?region=${{ env.AWS_REGION }}#/functions?f0=true&n0=false&op=and&v0=donatemate-staging-mcp)
            - [API Gateway](https://console.aws.amazon.com/apigateway/home?region=${{ env.AWS_REGION }})
            - [DynamoDB Tables](https://console.aws.amazon.com/dynamodbv2/home?region=${{ env.AWS_REGION }}#tables)

            _Deployment triggered by: ${{ github.actor }}_
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Upload deployment outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mcp-outputs
          path: packages/infrastructure/mcp-outputs.json
          retention-days: 7

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Comment failure on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ❌ MCP Staging Deployment Failed

            The deployment to staging environment has failed. Please check the workflow logs for details.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            _Failed for: ${{ github.actor }}_
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
