name: Deploy MCP to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      confirm_deploy:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        default: ''

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '20'
  AWS_REGION: 'us-east-2'
  ENVIRONMENT: 'production'

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Check deployment confirmation
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.confirm_deploy }}" != "deploy" ]; then
              echo "Deployment not confirmed. Type 'deploy' to proceed."
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "should_deploy=true" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy MCP Stack to Production
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-MCP-Deploy-Prod

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Type check
        run: npm run type-check --workspaces --if-present

      - name: CDK Bootstrap (if needed)
        working-directory: packages/infrastructure
        run: |
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }} \
            --context environment=${{ env.ENVIRONMENT }}

      - name: CDK Diff
        working-directory: packages/infrastructure
        run: |
          echo "=== Production CDK Diff ==="
          npx cdk diff \
            --context environment=${{ env.ENVIRONMENT }} \
            --require-approval never

      - name: Deploy MCP Stack
        working-directory: packages/infrastructure
        run: |
          npx cdk deploy DonateMate-MCP-Production \
            --context environment=${{ env.ENVIRONMENT }} \
            --require-approval never \
            --outputs-file mcp-outputs.json

      - name: Print deployment outputs
        working-directory: packages/infrastructure
        run: |
          echo "=== Production Deployment Outputs ==="
          cat mcp-outputs.json

      - name: Upload deployment outputs
        uses: actions/upload-artifact@v4
        with:
          name: mcp-production-outputs
          path: packages/infrastructure/mcp-outputs.json
          retention-days: 30

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Log failure
        run: |
          echo "Production deployment failed!"
          echo "Check the workflow run at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
